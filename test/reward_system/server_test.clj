(ns reward-system.server-test
	(:require [ring.mock.request :as mock]
		[clojure.test :refer :all]
		[reward-system.server :refer :all]))

(deftest test-get
	(testing "get result from little input"
		(is (= (app (mock/request :get "/little"))
			{:status 200
			  :headers {"Content-Type" "application/json"}
			  :body "{\"1\":2.5,\"2\":0,\"3\":1,\"4\":0,\"5\":0,\"6\":0}"})))
	(testing "get result from big input"
		(is (= (app (mock/request :get "/"))
			{:status 200
			  :headers {"Content-Type" "application/json"}
			  :body "{\"60\":0,\"72\":0,\"146\":0,\"14\":2.00000000069849193096160888671875,\"120\":0,\"109\":0,\"88\":0,\"39\":2.0234375,\"89\":0,\"37\":2.005859375,\"130\":0,\"59\":0,\"108\":0,\"96\":0,\"64\":0,\"27\":2.0000057220458984375,\"138\":0,\"42\":2.1875,\"45\":3.5,\"114\":0,\"149\":0,\"77\":0,\"83\":0,\"123\":0,\"31\":2.000091552734375,\"65\":0,\"40\":2.046875,\"18\":2.0000000111758708953857421875,\"52\":0,\"190\":0,\"12\":2.0000000001746229827404022216796875,\"115\":0,\"11\":2.00000000008731149137020111083984375,\"24\":2.0000007152557373046875,\"76\":0,\"75\":0,\"10\":2.000000000043655745685100555419921875,\"21\":2.0000000894069671630859375,\"125\":0,\"117\":0,\"56\":0,\"70\":0,\"110\":0,\"73\":0,\"118\":0,\"61\":0,\"142\":0,\"23\":2.00000035762786865234375,\"143\":0,\"13\":2.000000000349245965480804443359375,\"122\":0,\"66\":0,\"58\":0,\"126\":0,\"140\":0,\"119\":0,\"133\":0,\"30\":2.0000457763671875,\"38\":2.01171875,\"71\":0,\"53\":0,\"4\":2.000000000000682121026329696178436279296875,\"43\":2.375,\"57\":0,\"26\":2.00000286102294921875,\"79\":0,\"95\":0,\"98\":0,\"106\":0,\"16\":2.000000002793967723846435546875,\"131\":0,\"139\":0,\"44\":2.75,\"87\":0,\"85\":0,\"100\":0,\"7\":2.000000000005456968210637569427490234375,\"91\":0,\"105\":0,\"35\":2.00146484375,\"81\":0,\"55\":0,\"1\":2.000000000000085265128291212022304534912109375,\"78\":0,\"147\":0,\"160\":0,\"50\":50,\"8\":2.00000000001091393642127513885498046875,\"113\":0,\"62\":0,\"36\":2.0029296875,\"22\":2.000000178813934326171875,\"124\":0,\"47\":8,\"67\":0,\"74\":0,\"25\":2.000001430511474609375,\"9\":2.0000000000218278728425502777099609375,\"141\":0,\"20\":2.00000004470348358154296875,\"86\":0,\"135\":0,\"17\":2.00000000558793544769287109375,\"46\":5\"102\":0,\"144\":0,\"32\":2.00018310546875,\"49\":26,\"112\":0,\"28\":2.000011444091796875,\"48\":14,\"19\":2.000000022351741790771484375,\"69\":0,\"94\":0,\"2\":2.00000000000017053025658242404460906982421875,\"103\":0,\"148\":0,\"5\":2.00000000000136424205265939235687255859375,\"41\":2.09375,\"121\":0,\"90\":0,\"107\":0,\"137\":0,\"101\":0,\"111\":0,\"15\":2.0000000013969838619232177734375,\"145\":0,\"99\":0,\"97\":0,\"3\":2.0000000000003410605131648480892181396484375,\"93\":0,\"127\":0,\"6\":2.0000000000027284841053187847137451171875,\"33\":2.0003662109375,\"150\":0,\"51\":0,\"63\":0,\"104\":0,\"54\":0,\"116\":0,\"82\":0,\"84\":0,\"92\":0,\"80\":0,\"29\":2.00002288818359375,\"134\":0,\"132\":0,\"34\":2.000732421875,\"129\":0,\"128\":0,\"180\":0,\"68\":0,\"136\":0}"}))))

(deftest test-post
	(testing "post with no new invites"
		(is (= (app (mock/request :post "/"))
			{:status 200
			  :headers {"Content-Type" "application/json"}
			  :body "{\"1\":2.5,\"2\":0,\"3\":1,\"4\":0,\"5\":0,\"6\":0}"})))
	#_(testing "post with user inviting nil"
		(is (= (app (assoc (mock/request :post "/") :5 nil))
			{:status 200
			  :headers {"Content-Type" "application/json"}
			  :body "{\"1\":2.5,\"2\":\"0\",\"3\":1,\"4\":\"0\",\"5\":\"0\",\"6\":\"0\"}"})))
	#_(testing "post with nil inviting nil"
		(is (= (app (assoc (mock/request :post "/") nil nil))
			{:status 200
			  :headers {"Content-Type" "application/json"}
			  :body "{\"1\":2.5,\"2\":\"0\",\"3\":1,\"4\":\"0\",\"5\":\"0\",\"6\":\"0\"}"})))
	#_(testing "adding new invites to little input"
		(is (= (app (assoc (mock/request :post "/") :params {"obj" "{\"5\": 7, \"6\": 8}"}))
			{:status 200
			  :headers {"Content-Type" "application/json"}
			  :body "{\"1\":3,\"2\":\"0\",\"3\":2,\"4\":2,\"5\":\"0\",\"6\":\"0\",\"7\":\"0\",\"8\":\"0\"}"}))))